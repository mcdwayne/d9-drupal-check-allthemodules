<?php

/**
 * @file
 * Open Video Annotation using videojs HTML5 player.
 */

/**
 * Implements hook_theme().
 */
function ova_theme() {
  return array(
    'ovaAudio' => array(
      'variables' => array(
        'items' => NULL,
        'player_extension' => NULL,
        'player_attributes' => NULL,
        'player_image_path' => NULL,
        'entity' => NULL,
      ),
      'file' => 'ova.inc',
    ),
    'ovaVideo' => array(
      'variables' => array(
        'items' => NULL,
        'player_extension' => NULL,
        'player_attributes' => NULL,
        'entity' => NULL,
        'player_image_path' => NULL,
      ),
      'file' => 'ova.inc',
    ),
  );
}

/**
 * Implements hook_preprocess_HOOK().
 */
function ova_preprocess_ova(&$variables) {

  $node = \Drupal::routeMatch()->getParameter('node');
  $variables['get_nid'] = $node->id();
}

/**
 * Implements hook_annotation_store_search_endpoint_output_alter(&$entity).
 */
function ova_annotation_store_search_endpoint_output_alter(&$entity) {

  $annotations = array();
  $entity_annotations = $entity->content['data']['annotations'];
  if ($entity_annotations) {

    foreach ($entity_annotations as $key => $value) {
      if ($value['data']->media == 'audio' ||  $value['data']->media == 'video') {
        $annotations[] = array(
          'media' => $value['data']->media,
          'text' => $value['text'],
          'ranges' => array(),
          'uri' => $value['data']->uri,
          'id' => $value['id'],
          'target' => array(
            'container' => $value['data']->target->container,
            'ext' => $value['data']->target->ext,
            'src' => $value['data']->target->src,
          ),
          'rangeTime' => array(
            'start' => $value['data']->rangeTime->start,
            "end" => $value['data']->rangeTime->end,
          ),
        );
      }
    }
  }
  else {
    $annotations[] = array(
      'permissions' => array(
        'read' => array(),
        'update' => array(),
        'delete' => array(),
        'admin' => array(),
      ),
      'quote' => '',
      'media' => 'audio',
      'text' => dummy,
      'ranges' => array(),
      'uri' => 'http://dummy.com/dummy',
      'id' => 1,
      'target' => array(
        'container' => 'vjs_ova_1',
        'ext' => '.mp3',
        'src' => 'http://www.dummy.com/dummy.mp3',
      ),
      'rangeTime' => array(
        'start' => 6.559184,
        "end" => 8.559184,
      ),
    );
  }
  $rows = array(
    'rows' => $annotations,
  );
  $entity->content['data']['annotations'] = $rows;

}

/**
 * Implements hook_annotation_store_create_endpoint_output_alter(&$entity).
 */
function ova_annotation_store_create_endpoint_output_alter(&$entity, $id) {
  $create_annotations = $entity->content['data']['annotations'];
  $data = array(
    'permissions' => array(
      'read' => array(),
      'update' => array(),
      'delete' => array(),
      'admin' => array(),
    ),
    'quote' => '',
    'media' => $create_annotations->media,
    'text' => $create_annotations->text,
    'ranges' => array(),
    'uri' => $create_annotations->uri,
    'id' => $id,
    'data' => $create_annotations,
    'target' => array(
      'container' => $create_annotations->target->container,
      'ext' => $create_annotations->target->ext,
      'src' => $create_annotations->target->src,
    ),
    'rangeTime' => array(
      'start' => $create_annotations->rangeTime->start,
      "end" => $create_annotations->rangeTime->end,
    ),
  );
  $entity->content['data']['annotations'] = (object) $data;

}
