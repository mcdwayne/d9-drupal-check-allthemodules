<?php

/**
 * @file
 * Hook implementations for the External Entities module.
 */

use Drupal\Component\Utility\Xss;
use Drupal\Core\Render\Element;
use Drupal\Core\Url;
use Drupal\Core\Link;

/**
 * Implements hook_theme().
 */
function external_entities_theme() {
  return [
    'external_entities_add_list' => [
      'variables' => ['external_entity_types' => NULL],
    ],
    'external_entity' => [
      'render element' => 'elements',
    ],
  ];
}

/**
 * Prepares variables for list of available external entity type templates.
 *
 * Default template: external-entities-add-list.html.twig.
 *
 * @param array $variables
 *   An associative array containing:
 *   - content: An array of external entity types.
 */
function template_preprocess_external_entities_add_list(array &$variables) {
  $variables['types'] = [];
  if (!empty($variables['external_entity_types'])) {
    /* @var $type \Drupal\external_entities\ExternalEntityTypeInterface */
    foreach ($variables['external_entity_types'] as $type) {
      $url = new Url('external_entity.add', ['external_entity_type' => $type->id()]);
      $variables['types'][$type->id()] = [
        'type' => $type->id(),
        'add_link' => Link::fromTextAndUrl($type->label(), $url),
        'description' => Xss::filterAdmin($type->getDescription()),
      ];
    }
  }
}

/**
 * Prepares variables for external entity templates.
 *
 * Default template: external-entity.html.twig.
 *
 * @param array $variables
 *   An associative array containing:
 *   - elements: An associative array containing the external entity and any
 *     fields attached to the entity. Properties used:
 *     - #external_entity: A \Drupal\external_entities\Entity\ExternalEntity
 *       object.
 *     - #view_mode: The current view mode for this external entity, e.g.
 *       'full' or 'teaser'.
 *   - attributes: HTML attributes for the containing element.
 */
function template_preprocess_external_entity(array &$variables) {
  $variables['external_entity'] = $variables['elements']['#external_entity'];
  // Helpful $content variable for templates.
  $variables['content'] = [];
  foreach (Element::children($variables['elements']) as $key) {
    $variables['content'][$key] = $variables['elements'][$key];
  }
}
